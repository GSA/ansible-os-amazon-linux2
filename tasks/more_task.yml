---
- name: 5.3.20 - Ensure SSH AllowTcpForwarding is disabled (Scored)
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'AllowTcpForwarding no'
    regexp: ^(?i)(#|)\s*AllowTCPForwarding
    
  tags:
    - level-2
    - section-5
    - "5.3.20"
    - scored

- name: 5.3.21 - Ensure SELinux SSH_MaxStartups is configured (Scored)
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'MaxStartups {{ amazon2cis_ssh_maxstartups }}'
    regexp: ^(?i)(#|)\s*MaxStartups
    
  tags:
    - level-2
    - section-5
    - "5.3.21"
    - scored

- name: 5.3.22 - Ensure SSH MaxSessions is limited (Scored)
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'MaxSessions {{ amazon2cis_ssh_maxsessions }}'
    regexp:  ^(?i)(#|)\s*MaxSessions
    
  tags:
    - level-2
    - section-5
    - "5.3.22"
    - scored

- name: 4.2.2.3 - Ensure journald is configure to write logfiles to persistent disk (Scored)
  lineinfile:
    path: /etc/systemd/journald.conf
    line: 'Storage=persistent'
    regexp:  ^(?i)(#|)\s*Storage
    
  tags:
    - level-2
    - section-4
    - "4.2.2.3"
    - scored

- name: 4.2.2.1 - Ensure journald is configured to send logs to rsyslog (Scored)
  lineinfile:
    path: /etc/systemd/journald.conf
    line: 'ForwardToSyslog=yes'
    regexp:  ^(?i)(#|)\s*ForwardToSyslog
    
  tags:
    - level-2
    - section-4
    - "4.2.2.1"
    - scored

- name:   Ensure journald is configured to compress large log files (Scored)
  lineinfile:
    path: /etc/systemd/journald.conf
    line: 'Compress=yes'
    regexp:  ^(?i)(#|)\s*Compress
    

  name: 4.1.1.3 - Ensure auditing for processes that start prior to auditd is enabled (Scored)
  lineinfile:
    path: /etc/default/grub
    line: 'GRUB_CMDLINE_LINUX="audit=1"'
    regexp: '^GRUB_CMDLINE_LINUX='
  tags:
    - level-2
    - section-4
    - "4.1.1.3"
    - scored


- name: 4.1.2.4 - Ensure audit_backlog_limit is sufficient (Scored)
  lineinfile:
    path: /etc/default/grub
    line: 'GRUB_CMDLINE_LINUX="audit_backlog_limit=8192"'
    regexp: '^GRUB_CMDLINE_LINUX='
  notify:
    - Update GRUB configuration
  tags:
    - level-2
    - section-4
    - "4.1.2.4"
    - scored


  
